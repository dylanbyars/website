name: Build and Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install

      - name: Install pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc

      - name: Install typst
        run: |
          curl -fsSL https://github.com/typst/typst/releases/latest/download/typst-x86_64-unknown-linux-musl.tar.xz | tar -xJ
          sudo mv typst-x86_64-unknown-linux-musl/typst /usr/local/bin/

      - name: Set up rclone
        uses: AnimMouse/setup-rclone@v1
        with:
          rclone_config: |
            [fastmail]
            type = webdav
            url = ${{ secrets.FASTMAIL_WEBDAV_URL }}
            vendor = other
            user = ${{ secrets.FASTMAIL_USERNAME }}
            pass = ${{ secrets.FASTMAIL_APP_PASSWORD }}

      - name: Build all assets
        run: make all

      - name: Deploy to Fastmail
        run: |
          rclone sync static/public/ "fastmail:${{ secrets.FASTMAIL_WEBDAV_PATH }}" \
            --progress \
            --exclude .DS_Store \
            --exclude '._*' \
            --exclude '.git*' \
            --exclude 'Thumbs.db' \
            --delete-excluded

      - name: Deployment complete
        run: echo "âœ“ Deployed to https://dylanbyars.com"
